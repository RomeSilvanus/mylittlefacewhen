// Generated by CoffeeScript 1.3.1

window.RandomsView = Backbone.View.extend({
  el: "#content",
  initialize: function() {
    var _this = this;
    this.loading = false;
    this.template = tpl.get("randoms");
    $(window).on("resize.randoms", function(event) {
      if (atBottom(500)) {
        return _this.loadMore();
      }
    });
    return $(window).on("scroll.randoms", function(event) {
      if (atBottom(500)) {
        return _this.loadMore();
      }
    });
  },
  beforeClose: function() {
    return $(window).off(".randoms");
  },
  render: function() {
    this.updateMeta();
    this.$el.html(Mustache.render(this.template, {
      static_prefix: static_prefix
    }));
    this.loadMore();
    return this;
  },
  updateMeta: function() {
    $("title").html("Random images - MyLittleFaceWhen");
    $("meta[name=description]").attr("content", "Endless list of random pony-related reaction images. Goes on-and-on-and-on-and...");
    $("#og-image").attr("content", "http://mylittlefacewhen.com/static/cheerilee-square-300.png");
    $("#cd-layout").remove();
    return $("link[rel=image_src]").remove();
  },
  loadMore: function() {
    var collection,
      _this = this;
    if (!this.loading) {
      this.loading = true;
      $("#loader").show();
      collection = new FaceCollection();
      return collection.fetch({
        data: $.param({
          order_by: "random",
          limit: 3
        }),
        success: function(data) {
          _.each(collection.models, function(model) {
            if (!app.randFaceList.get(model.id)) {
              app.randFaceList.add(model);
            }
            return $("#randoms").append(new RandomsImage({
              model: model
            }).render().el);
          });
          $("#loader").hide();
          _this.loading = false;
          if (data.length > 0) {
            if (atBottom(500)) {
              return _this.loadMore();
            }
          } else {
            return $("#loadMore").hide();
          }
        },
        error: function() {
          $("#loader").hide();
          return this.loading = false;
        }
      });
    }
  }
});

window.RandomsImage = Backbone.View.extend({
  tagName: "div",
  className: "listimage",
  initialize: function() {
    return this.template = tpl.get("randomsImage");
  },
  render: function() {
    var image, model, to_template;
    model = this.model.toJSON();
    image = this.getImageBySize(model);
    image = app.getImageService() + image;
    to_template = {
      model: model,
      image: image,
      static_prefix: static_prefix
    };
    this.$el.html(Mustache.render(this.template, to_template));
    $(this.el.firstChild).on("click", this.navigateAnchor);
    $(this.el.firstChild.firstChild).load(function() {
      return $(this).removeClass('fixedHeight');
    });
    return this;
  },
  getImageBySize: function(data) {
    var browser_width;
    browser_width = $(document).width();
    if (data.width > data.height) {
      if (browser_width < 450 && data.resizes.small) {
        return data.resizes.small;
      } else if (browser_width < 750 && data.resizes.medium) {
        return data.resizes.medium;
      } else {
        return data.image;
      }
    } else {
      if (browser_width < 320 && data.resizes.small) {
        return data.resizes.small;
      }
      if (browser_width < 640 && data.resizes.medium) {
        return data.resizes.medium;
      } else if (data.resizes.large) {
        return data.resizes.large;
      } else {
        return data.image;
      }
    }
  }
});
