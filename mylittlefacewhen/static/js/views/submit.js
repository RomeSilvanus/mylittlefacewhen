// Generated by CoffeeScript 1.3.1

window.SubmitView = Backbone.View.extend({
  el: "#content",
  initialize: function() {
    return this.template = _.template(tpl.get("submit"));
  },
  events: {
    "dragover #dropzone": "handleDragover",
    "drop #dropzone": "handleDrop",
    "change #files": "handleChoose",
    "click #upload": "upload",
    "click #instructions button": "toggleInstructions",
    "click #to-unreviewed a": "navigateAnchor"
  },
  render: function() {
    this.updateMeta();
    $(this.el).html(this.template({
      static_prefix: static_prefix
    }));
    return this;
  },
  updateMeta: function() {
    $("title").html("Submit Images - MyLittleFaceWhen");
    $("meta[name=description]").attr("content", "Upload more images to the service");
    $("#og-image").attr("content", "http://mylittlefacewhen.com/static/cheerilee-square-300.png");
    $("#cd-layout").remove();
    return $("link[rel=image_src]").remove();
  },
  handleChoose: function(event) {
    return this.handleFiles(event.target.files);
  },
  handleDragover: function(event) {
    event = event.originalEvent;
    event.stopPropagation();
    event.preventDefault();
    return event.dataTransfer.dropEffect = "copy";
  },
  handleDrop: function(event) {
    event = event.originalEvent;
    event.stopPropagation();
    event.preventDefault();
    return this.handleFiles(event.dataTransfer.files);
  },
  handleFiles: function(files) {
    var file, item, thumbs, updates, _i, _len;
    updates = [];
    for (_i = 0, _len = files.length; _i < _len; _i++) {
      file = files[_i];
      if (!(file.type.match("image.*"))) {
        continue;
      }
      item = {
        "image": file
      };
      updates.push(item);
    }
    thumbs = $(this.el).find("#upload_list ul");
    _.each(updates, function(update) {
      var reader;
      reader = new FileReader();
      reader.onload = (function(update) {
        return function(event) {
          item = new SubmitItemView().render(update.image, event.target.result);
          return $("#upload_list ul").append(item.el);
        };
      })(update);
      return reader.readAsDataURL(update.image);
    });
    return $("#upload").show();
  },
  upload: function(event) {
    var upload_button;
    this.undelegateEvents();
    upload_button = event.currentTarget;
    $(upload_button).find("span").html("uploading");
    $("#loader").show();
    return _.each($("#upload_list li"), function(item) {
      var face, img, source, tags;
      tags = $(item).find(".tags").val();
      if ($(item).find("input[name=transparent]")[0].checked) {
        tags += ", transparent";
      }
      if ($(item).find("input[name=fanart]")[0].checked) {
        tags += ", fanart";
      }
      if ($(item).find("input[name=screenshot]")[0].checked) {
        tags += ", screenshot";
      }
      source = $(item).find(".source").val();
      img = $(item).find("img");
      face = new Face({
        name: img.attr("title"),
        image_data: img.attr("src"),
        tags: tags,
        source: source
      });
      return face.save(void 0, {
        success: function() {
          $(item).remove();
          if ($("#upload_list ul").children().length === 0) {
            return app.navigate("/unreviewed/", true);
          }
        },
        error: function() {
          return $(item).find(".info").addClass("error").css("color", "black").css("background-color", "red").html("An error has ocurred with this image");
        }
      });
    });
  },
  toggleInstructions: function(event) {
    return $("#instructions div").toggle();
  }
});

window.SubmitItemView = Backbone.View.extend({
  tagName: "li",
  initialize: function() {
    return this.template = tpl.get("submitItem");
  },
  events: {
    "click .controls": "remove"
  },
  render: function(image, imageURL) {
    var _this = this;
    $(this.el).html(Mustache.render(this.template, {
      image: image,
      imageURL: imageURL
    }));
    $.get("/api/v2/detect/?filename=" + image.name, function(data) {
      $(_this.el).find(".tags").val(data.tags);
      return $(_this.el).find(".source").val(data.source);
    });
    return this;
  }
});
